<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes Migration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #1a4d1a; border: 1px solid #2d7d2d; }
        .error { background: #4d1a1a; border: 1px solid #7d2d2d; }
        .info { background: #1a3a4d; border: 1px solid #2d5a7d; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2563eb; }
        .svg-preview {
            border: 1px solid #444;
            background: #333;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        pre {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üß™ Notes Migration Test</h1>
    
    <div class="test-section">
        <h2>Step 1: Setup Test Data</h2>
        <p>This will create test customers with old notesHtml data in IndexedDB</p>
        <button onclick="setupTestData()">Setup Test Data</button>
        <div id="setup-result"></div>
    </div>

    <div class="test-section">
        <h2>Step 2: Run Migration</h2>
        <p>This will run the migration function to convert old notes to new SVG system</p>
        <button onclick="runMigration()">Run Migration</button>
        <div id="migration-result"></div>
    </div>

    <div class="test-section">
        <h2>Step 3: Verify Results</h2>
        <p>Check that notes were properly converted and stored</p>
        <button onclick="verifyResults()">Verify Results</button>
        <div id="verification-result"></div>
    </div>

    <div class="test-section">
        <h2>Step 4: Cleanup</h2>
        <p>Clear test data</p>
        <button onclick="cleanup()">Cleanup Test Data</button>
        <div id="cleanup-result"></div>
    </div>

    <script src="js/db.js"></script>
    <script src="migration-test.js"></script>
    <script>
        // Test data - simulating old notesHtml from backup
        // Note: IDs will be auto-generated by IndexedDB
        const testCustomers = [
            {
                firstName: 'Test',
                lastName: 'Customer 1',
                contactNumber: '1234567890',
                notesHtml: '<p><span style="background-color: rgb(31, 31, 31); color: rgb(238, 240, 255);">Glasses, children, two boys</span></p>',
                createdAt: new Date().toISOString()
            },
            {
                firstName: 'Test',
                lastName: 'Customer 2',
                contactNumber: '0987654321',
                notesHtml: '<p><span style="color: rgb(238, 240, 255); background-color: rgb(31, 31, 31);">introduced by Charlie, last had her hair cut by Takeshi about 4 years ago</span></p>',
                createdAt: new Date().toISOString()
            },
            {
                firstName: 'Test',
                lastName: 'Customer 3',
                contactNumber: '5555555555',
                notesHtml: '<p><br></p>', // Empty note - should be skipped
                createdAt: new Date().toISOString()
            },
            {
                firstName: 'Test',
                lastName: 'Customer 4',
                contactNumber: '1111111111',
                notesHtml: '<p>Simple text note without styling</p>',
                createdAt: new Date().toISOString()
            }
        ];

        // Store created customer IDs for cleanup
        let createdCustomerIds = [];

        async function setupTestData() {
            const resultDiv = document.getElementById('setup-result');
            resultDiv.innerHTML = '<div class="info">Setting up test data...</div>';

            try {
                // Clear any existing test data
                await cleanup();
                
                // Add test customers to IndexedDB and track their IDs
                createdCustomerIds = [];
                for (const customer of testCustomers) {
                    const createdId = await ChikasDB.createCustomer(customer);
                    createdCustomerIds.push(createdId);
                    console.log(`Created test customer with ID: ${createdId}`);
                }

                resultDiv.innerHTML = `
                    <div class="success">‚úÖ Test data setup complete!</div>
                    <div class="info">
                        <strong>Added ${testCustomers.length} test customers:</strong>
                        <ul>
                            ${testCustomers.map((c, index) => `<li>${c.firstName} ${c.lastName} (ID: ${createdCustomerIds[index]}) - "${c.notesHtml}"</li>`).join('')}
                        </ul>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error setting up test data: ${error.message}</div>`;
            }
        }

        async function runMigration() {
            const resultDiv = document.getElementById('migration-result');
            resultDiv.innerHTML = '<div class="info">Running migration...</div>';

            try {
                // Check if migration function is available
                if (typeof migrateOldNotes === 'undefined') {
                    throw new Error('migrateOldNotes function is not available. Make sure migration-test.js is loaded properly.');
                }
                
                console.log('migrateOldNotes function found:', typeof migrateOldNotes);
                
                // Run the standalone migration function
                const result = await migrateOldNotes();
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Migration completed successfully!</div>
                        <div class="info">
                            <strong>Migration Results:</strong>
                            <ul>
                                <li>Total customers processed: ${result.totalCustomers}</li>
                                <li>Customers migrated: ${result.migratedCount}</li>
                                <li>Check console for detailed logs</li>
                            </ul>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Migration failed: ${result.error}</div>`;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error running migration: ${error.message}</div>`;
            }
        }

        async function verifyResults() {
            const resultDiv = document.getElementById('verification-result');
            resultDiv.innerHTML = '<div class="info">Verifying migration results...</div>';

            try {
                // Run the verification function
                const result = await verifyMigrationResults();
                
                if (result.success) {
                    // Get detailed info for display
                    const customerNotes = JSON.parse(localStorage.getItem('customerNotes') || '{}');
                    
                    // Find test customers by checking if they have notes and matching the created IDs
                    const testCustomerNotes = [];
                    const allCustomerIds = Object.keys(customerNotes);
                    
                    // Check if any of our created customer IDs have notes
                    for (const customerId of createdCustomerIds) {
                        if (customerNotes[customerId]) {
                            testCustomerNotes.push(customerId);
                        }
                    }
                    
                    // Also check for any customers with "Test" in their name that have notes
                    const allCustomers = await ChikasDB.getAllCustomers();
                    const testCustomersWithNotes = allCustomers.filter(c => 
                        c.firstName === 'Test' && 
                        c.lastName && 
                        c.lastName.startsWith('Customer') &&
                        customerNotes[c.id]
                    );
                    
                    // Add any test customers we found by name
                    testCustomersWithNotes.forEach(customer => {
                        if (!testCustomerNotes.includes(customer.id)) {
                            testCustomerNotes.push(customer.id);
                        }
                    });
                    
                    let verificationHTML = '<div class="success">‚úÖ Verification Results:</div>';
                    verificationHTML += '<div class="info">';
                    verificationHTML += `<strong>Summary:</strong><br>`;
                    verificationHTML += `- Total customers: ${result.totalCustomers}<br>`;
                    verificationHTML += `- Customers with notes: ${result.customersWithNotes}<br>`;
                    verificationHTML += `- Total notes: ${result.totalNotes}<br>`;
                    verificationHTML += `- Customers still with notesHtml: ${result.customersStillWithNotesHtml}<br>`;
                    
                    verificationHTML += `<br><strong>Test Customer Details:</strong><br>`;
                    verificationHTML += `Found notes for ${testCustomerNotes.length} test customers<br>`;
                    verificationHTML += `Created customer IDs: ${createdCustomerIds.join(', ')}<br>`;
                    
                    // Show details for each migrated test customer
                    testCustomerNotes.forEach(customerId => {
                        const notes = customerNotes[customerId];
                        const customer = allCustomers.find(c => c.id == customerId);
                        const customerName = customer ? `${customer.firstName} ${customer.lastName}` : `ID ${customerId}`;
                        
                        verificationHTML += `<br><strong>Customer ${customerName} (ID: ${customerId}):</strong><br>`;
                        verificationHTML += `- Notes count: ${notes.length}<br>`;
                        notes.forEach((note, index) => {
                            verificationHTML += `- Note ${index + 1}: ${note.date} (${note.noteNumber})<br>`;
                            verificationHTML += `<div class="svg-preview">`;
                            verificationHTML += `<strong>SVG Content:</strong><br>`;
                            verificationHTML += `<pre>${note.svg}</pre>`;
                            verificationHTML += `<strong>Rendered SVG:</strong><br>`;
                            verificationHTML += `<div style="border: 1px solid #666; background: #000; padding: 10px; margin: 5px 0;">${note.svg}</div>`;
                            verificationHTML += `</div>`;
                        });
                    });
                    
                    // If no test customers found, show all customers with notes for debugging
                    if (testCustomerNotes.length === 0) {
                        verificationHTML += `<br><strong>Debug - All Customers with Notes:</strong><br>`;
                        allCustomerIds.forEach(customerId => {
                            const notes = customerNotes[customerId];
                            const customer = allCustomers.find(c => c.id == customerId);
                            const customerName = customer ? `${customer.firstName} ${customer.lastName}` : `ID ${customerId}`;
                            verificationHTML += `- ${customerName} (ID: ${customerId}): ${notes.length} notes<br>`;
                        });
                    }
                    
                    verificationHTML += '</div>';
                    
                    resultDiv.innerHTML = verificationHTML;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Verification failed: ${result.error}</div>`;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error verifying results: ${error.message}</div>`;
            }
        }

        async function cleanup() {
            const resultDiv = document.getElementById('cleanup-result');
            resultDiv.innerHTML = '<div class="info">Cleaning up test data...</div>';

            try {
                // Remove test customers from IndexedDB using tracked IDs
                let deletedCount = 0;
                
                if (createdCustomerIds.length > 0) {
                    console.log(`Deleting ${createdCustomerIds.length} tracked test customers:`, createdCustomerIds);
                    
                    for (const customerId of createdCustomerIds) {
                        console.log(`Deleting customer with ID: ${customerId} (type: ${typeof customerId})`);
                        try {
                            await ChikasDB.deleteCustomer(customerId);
                            console.log(`Successfully deleted customer ${customerId}`);
                            deletedCount++;
                        } catch (deleteError) {
                            console.error(`Failed to delete customer ${customerId}:`, deleteError);
                            // Continue with other deletions even if one fails
                        }
                    }
                } else {
                    // Fallback: find test customers by name if we don't have tracked IDs
                    const customers = await ChikasDB.getAllCustomers();
                    const testCustomers = customers.filter(c => 
                        c.firstName === 'Test' && c.lastName && c.lastName.startsWith('Customer')
                    );
                    
                    console.log(`Found ${testCustomers.length} test customers by name:`, testCustomers);
                    
                    for (const customer of testCustomers) {
                        console.log(`Deleting customer with ID: ${customer.id} (type: ${typeof customer.id})`);
                        try {
                            await ChikasDB.deleteCustomer(customer.id);
                            console.log(`Successfully deleted customer ${customer.id}`);
                            deletedCount++;
                        } catch (deleteError) {
                            console.error(`Failed to delete customer ${customer.id}:`, deleteError);
                            // Continue with other deletions even if one fails
                        }
                    }
                }
                
                // Remove test notes from localStorage
                const customerNotes = JSON.parse(localStorage.getItem('customerNotes') || '{}');
                const testCustomerIds = Object.keys(customerNotes).filter(id => id.startsWith('test-customer-'));
                
                testCustomerIds.forEach(id => {
                    delete customerNotes[id];
                });
                
                localStorage.setItem('customerNotes', JSON.stringify(customerNotes));
                
                resultDiv.innerHTML = `
                    <div class="success">‚úÖ Cleanup complete!</div>
                    <div class="info">
                        Removed ${deletedCount} test customers from IndexedDB<br>
                        Removed notes for ${testCustomerIds.length} test customers from localStorage
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error during cleanup: ${error.message}</div>`;
            }
        }

        // Fallback functions if external script fails to load
        if (typeof migrateOldNotes === 'undefined') {
            console.warn('‚ö†Ô∏è migrateOldNotes not found, defining fallback...');
            
            // Simple fallback migration function
            window.migrateOldNotes = async function() {
                console.log('üß™ Running fallback migration...');
                
                try {
                    const customers = await ChikasDB.getAllCustomers();
                    let migratedCount = 0;
                    
                    for (const customer of customers) {
                        if (customer.notesHtml && customer.notesHtml.trim() !== '' && customer.notesHtml !== '<p><br></p>') {
                            console.log(`üìù Migrating notes for customer ${customer.id}: ${customer.firstName} ${customer.lastName}`);
                            
                            // Simple SVG conversion
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = customer.notesHtml;
                            const textContent = tempDiv.textContent || tempDiv.innerText || '';
                            
                            if (textContent.trim()) {
                                // Calculate dynamic height based on text content
                                const lines = textContent.split('\n').filter(line => line.trim());
                                const maxCharsPerLine = 50;
                                let processedLines = [];
                                
                                lines.forEach(line => {
                                    if (line.trim()) {
                                        if (line.length > maxCharsPerLine) {
                                            const words = line.split(' ');
                                            let currentLine = '';
                                            
                                            words.forEach(word => {
                                                if ((currentLine + ' ' + word).length > maxCharsPerLine && currentLine.length > 0) {
                                                    processedLines.push(currentLine.trim());
                                                    currentLine = word;
                                                } else {
                                                    currentLine += (currentLine.length > 0 ? ' ' : '') + word;
                                                }
                                            });
                                            
                                            if (currentLine.trim()) {
                                                processedLines.push(currentLine.trim());
                                            }
                                        } else {
                                            processedLines.push(line.trim());
                                        }
                                    }
                                });
                                
                                const lineHeight = 20;
                                const padding = 20;
                                const minHeight = 60;
                                const calculatedHeight = Math.max(minHeight, (processedLines.length * lineHeight) + padding);
                                
                                // Create SVG with proper sizing
                                let svgText = `<svg xmlns="http://www.w3.org/2000/svg" width="400" height="${calculatedHeight}" viewBox="0 0 400 ${calculatedHeight}">`;
                                svgText += `<text x="10" y="30" font-family="Arial" font-size="16" fill="#ffffff">`;
                                
                                processedLines.forEach((line, index) => {
                                    svgText += `<tspan x="10" dy="${index === 0 ? '0' : '20'}">${line}</tspan>`;
                                });
                                
                                svgText += `</text></svg>`;
                                
                                const svg = svgText;
                                
                                const noteData = {
                                    id: Date.now() + Math.random(),
                                    svg: svg,
                                    date: customer.createdAt ? new Date(customer.createdAt).toLocaleDateString() : new Date().toLocaleDateString(),
                                    noteNumber: 1
                                };
                                
                                const existingNotes = JSON.parse(localStorage.getItem('customerNotes') || '{}');
                                if (!existingNotes[customer.id]) {
                                    existingNotes[customer.id] = [];
                                }
                                existingNotes[customer.id].push(noteData);
                                localStorage.setItem('customerNotes', JSON.stringify(existingNotes));
                                
                                const updatedCustomer = { ...customer };
                                delete updatedCustomer.notesHtml;
                                await ChikasDB.updateCustomer(updatedCustomer);
                                
                                migratedCount++;
                            }
                        }
                    }
                    
                    return {
                        success: true,
                        migratedCount,
                        totalCustomers: customers.length
                    };
                } catch (error) {
                    console.error('‚ùå Fallback migration error:', error);
                    return {
                        success: false,
                        error: error.message
                    };
                }
            };
        }

        // Fallback verification function if external script fails to load
        if (typeof verifyMigrationResults === 'undefined') {
            console.warn('‚ö†Ô∏è verifyMigrationResults not found, defining fallback...');
            
            window.verifyMigrationResults = async function() {
                console.log('üîç Running fallback verification...');
                
                try {
                    const customerNotes = JSON.parse(localStorage.getItem('customerNotes') || '{}');
                    const totalNotes = Object.values(customerNotes).reduce((sum, notes) => sum + notes.length, 0);
                    
                    const customers = await ChikasDB.getAllCustomers();
                    const customersWithNotesHtml = customers.filter(c => c.notesHtml !== undefined);
                    
                    return {
                        success: true,
                        totalCustomers: customers.length,
                        customersWithNotes: Object.keys(customerNotes).length,
                        totalNotes,
                        customersStillWithNotesHtml: customersWithNotesHtml.length
                    };
                } catch (error) {
                    console.error('‚ùå Fallback verification error:', error);
                    return {
                        success: false,
                        error: error.message
                    };
                }
            };
        }

        // Auto-run setup when page loads
        window.addEventListener('load', () => {
            console.log('Migration test page loaded. Click "Setup Test Data" to begin.');
            
            // Check if migration functions are available
            if (typeof migrateOldNotes === 'undefined') {
                console.error('‚ùå migrateOldNotes function not found! Check if migration-test.js loaded properly.');
            } else {
                console.log('‚úÖ migrateOldNotes function loaded successfully');
            }
            
            if (typeof verifyMigrationResults === 'undefined') {
                console.error('‚ùå verifyMigrationResults function not found!');
            } else {
                console.log('‚úÖ verifyMigrationResults function loaded successfully');
            }
        });
    </script>
</body>
</html>

